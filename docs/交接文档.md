# 3D‑MARKER Step‑13 前端产品化 交接文档（M0–M3）/ 交接记录（2025‑11‑05）

本交接文档面向下一位同事，概述当前预发实现、代码位置、接口约定、环境依赖、测试与常见问题排查。对应提交已推送到 `origin/main`。

参考资料：
- 产品 PRD：`docs/PRD-3D-MARKER.md`
- Step‑13 计划：`docs/steps/step-13-frontend-ui-plan.md`
- hitem3D API 本地镜像：`docs/hitem3d-api/README.md` 与 `docs/hitem3d-api/pages/zh/api/api-reference/list/*.md`

---

## 补充更新（2025‑11‑08）

本次补充迭代聚焦“默认 OBJ 流程、直链推理修复、OBJ 在线预览与加载体验”。要点如下：

- 供应商直链推理（同任务多格式）的健壮性修复
  - 场景：供应商默认返回 `0.obj.zip` 或 `*.obj` 时，需要“推理”出同目录下其它格式直链（glb/stl/fbx）。
  - 修复：统一剥离双扩展（如 `.obj.zip`），仅在请求 OBJ 时才尝试 `base.zip`；其它格式优先 `base.<fmt>.zip` → `base.<fmt>`；避免把 `base.zip`（OBJ 包）误当作 GLB。
  - 影响文件：
    - `app/api/assets/[uuid]/renditions/route.ts:buildCandidateUrls`
    - `app/api/hitem3d/callback/route.ts:buildCandidateUrls`
    - `app/api/cron/hitem3d-auto-finalize/route.ts:buildCandidateUrls`

- OBJ 文件清单接口增强（支持从 R2 内置 zip 解包）
  - `GET /api/assets/:uuid/renditions/files?format=obj`：若仅存在 `file.obj.zip` 或仅有 `.obj`，会：
    1) 优先拉取供应商 zip；
    2) 否则从 R2 中已落库的 `file.obj.zip` 解包到 `assets/<user>/<asset>/obj/`；
    3) 只返回可渲染文件（`.obj/.mtl/.png/.jpg/.jpeg/.webp`）。
  - 全部清单条目按 `Content‑Disposition=inline` 签名，确保浏览器子资源可直接加载（不触发下载）。
  - 调试：可在请求参数中加 `debug=1` 获取 `steps/uploads`（已脱敏）。
  - 影响文件：`app/api/assets/[uuid]/renditions/files/route.ts`（新增 zip 解析、R2 解包与 inline 签名）。

- 仅保留 OBJ 派生（前端层面）
  - `components/assets/RenditionsPanel.tsx` 现阶段仅暴露 OBJ，隐藏 GLB/STL/FBX 的“生成与下载”按钮（后端仍兼容）。

- 资产详情页改为 OBJ 在线预览
  - 新增：`components/assets/ViewerOBJ.tsx`（Three.js + OBJLoader + MTLLoader）
    - 通过 npm 方式打包 `three` 与 `examples/jsm/*`，彻底移除对 unpkg 的依赖；避免 CDN/CSP 造成的初始化失败。
    - MTL 设置 `resourcePath`，URL 映射大小写/基名容错，纹理/MTL/OBJ 均走签名直链。
    - sRGB 输出、改良灯光；相机自动取景（完整框选模型）。
    - 兜底贴图：若 MTL 未命中任何 `map_*`，会将清单里的第一张图片应用到 Mesh（保证不是灰模，便于用户确认成品）。
    - 加载进度覆盖层（仅覆盖预览区域）：
      - 采用“目标进度 + 缓动逼近”的丝滑动画；
      - LoadingManager 阶段：10→90→95；`onLoad` 解析：98；首帧渲染：100；
      - 进度到 100% 后 150ms 再揭罩显示模型，避免闪烁。
    - Debug 模式：默认隐藏调试文案，访问详情页时在 URL 加 `?debug=1` 或 `?objdebug=1` 可显示“加载开始/加载中/解析中/就绪”等详细状态。
  - 新增：`components/assets/AssetAutoPreviewOBJ.tsx`（调用 files 接口物化并下发清单，透传 debug 开关）。
  - 页面：`app/[locale]/(default)/(console)/my-assets/[uuid]/page.tsx` 替换为“OBJ 预览”。

- 构建与依赖
  - 依赖：`three@^0.160.x`、`@types/three@^0.160.x`。
  - Vercel：新增 `shipany-template/vercel.json`，安装命令改为 `pnpm install --no-frozen-lockfile`，以便 CI 安装新增依赖与类型定义。

### 验收建议
- 打开资产详情页：应看到“进度遮罩 + 旋转指示 + 百分比”，进度平滑推进，100% 后显示模型。
- 若 MTL 命中：应显示带纹理颜色；若未命中：兜底贴图会使模型非灰模（便于确认）。
- 若需调试：在 URL 加 `?debug=1` 查看状态；或访问 `GET /api/assets/:uuid/renditions/files?format=obj&debug=1` 查看物化与解包过程。

### 变更清单（代码路径）
- 直链推理修复：
  - `app/api/assets/[uuid]/renditions/route.ts`
  - `app/api/hitem3d/callback/route.ts`
  - `app/api/cron/hitem3d-auto-finalize/route.ts`
- OBJ 文件清单与解包：`app/api/assets/[uuid]/renditions/files/route.ts`
- OBJ 预览组件：
  - `components/assets/ViewerOBJ.tsx`
  - `components/assets/AssetAutoPreviewOBJ.tsx`
  - `app/[locale]/(default)/(console)/my-assets/[uuid]/page.tsx`
- 仅保留 OBJ（前端）：`components/assets/RenditionsPanel.tsx`
- 构建与依赖：`package.json`、`vercel.json`

### 风险与已知限制
- 某些供应商任务的 MTL 可能未包含 `map_*` 引用或使用了非标准相对路径；本次已通过“兜底贴图 + 容错 URL 映射”提升成功率，但最佳体验仍依赖供应商产物质量。
- 若需“一键 GLB 在线预览”作为替代，也可在详情页并行保留 GLB Viewer（当前已切换为 OBJ 优先）。

---

## 本次交付（2025‑11‑05）

以下内容为本次对话期间完成并已合入的交付与变更，便于后续接手与生产验证。

- 生成页（多视图 + 人像，UI 对齐参考图）
  - 新增容器 `components/generator/GeneratePanel.tsx`，支持“通用/人像”切换与“单图/多视图”页签；多视图前/后/左/右布局对齐，20MB 校验；人像固定纹理与 1536 分辨率。
  - 单图/多视图表单重构为卡片样式，底部参数栏与“生成”按钮；多视图仅前视图时走 `images`，存在侧视图走 `multi_images`（顺序前/后/左/右）。
  - 新增/更新 UI 测试，确保表单参数与 FormData 构造正确。

- 后端提交与错误映射
  - `app/api/hitem3d/submit/route.ts`：`resolveCreditsCost` 抛错映射为 400；统一默认面数；固定纹理的人像支持；一图/多图互斥校验；默认 GLB。

- 任务找回与自动化
  - 兜底单个：`POST /api/hitem3d/finalize` 支持“若已存在同 task_id 的资产且缺文件则就地更新”（避免重复资产）。
  - 批量找回（管理员）：`POST /api/hitem3d/finalize/batch`，支持指定 `task_ids` 或自动扫描最近“成功但未落库”的任务（`models/generation-task:listSuccessTasksWithoutAsset`）。
  - 自动化找回（Vercel Cron）：`GET /api/cron/hitem3d-auto-finalize`（每 10 分钟），可用 `AUTO_FINALIZE_LIMIT` 控制批量数量；支持 `AUTO_FINALIZE_TOKEN` 手动触发。

- 资产预览（GLB）
  - 详情页新增“GLB 自动预览” `components/assets/AssetAutoPreviewGLB.tsx`：优先原始 GLB，其次派生 GLB；签名链接 `disposition=inline`；`<model-viewer crossorigin="anonymous">`。
  - 回调/兜底下载落库时写入正确 Content‑Type（glb：`model/gltf-binary`；图片：`image/*`）。

- 按需格式（renditions）
  - `POST /api/assets/:uuid/renditions` / `GET /renditions`：新增“供应商直链回退”尝试。若同目录存在 `file.<fmt>.zip`/`file.zip`，优先使用；否则尝试 `file.<fmt>`。
  - OBJ 打包尝试：当供应商无 zip 时，服务端抓取 `.obj`、解析 `.mtl`、拉取贴图并以 store 方式生成 zip（`file.obj.zip`）作为下载。已修正 ZIP 头与 DOS 时间戳以提升兼容性（macOS 解压器仍可能对极端情况挑剔，已提供替代方案见下）。
  - 新增“单文件下载清单”接口：`GET /api/assets/:uuid/renditions/files?format=obj` 会按需“物化” OBJ/MTL/贴图到 R2 的 `assets/<user>/<asset>/obj/` 并返回签名链接清单。前端 OBJ 下载改为新窗口打开清单并逐个下载（`components/assets/RenditionsPanel.tsx`）。
  - `RENDITIONS_INSTANT_READY_FOR_ORIGINAL=1`：当请求格式与原始一致（例如原始 GLB→生成 GLB）时，直接标记就绪并复用原始文件。

- 存储与 CORS
  - R2 CORS 建议配置（示例）：
    [
      {
        "AllowedOrigins": ["https://<your-site>", "http://localhost:3000"],
        "AllowedMethods": ["GET", "HEAD"],
        "AllowedHeaders": ["Authorization","Origin","Range","Content-Type","Accept","If-None-Match","If-Modified-Since","Cache-Control"],
        "ExposeHeaders": ["Accept-Ranges","Content-Length","Content-Range","Content-Type","ETag"],
        "MaxAgeSeconds": 86400
      }
    ]

- 数据库迁移
  - 新增 `data/migrations/005-create-asset-renditions.sql`（`asset_renditions` 表），用于按需格式导出状态记录。

- 测试与稳定性
  - 当前项目测试 90+ 项通过（含此次新增逻辑的集成/UI 测试）。
  - 主要风险点：供应商是否提供多格式直链与鉴权参数继承；ZIP 兼容性（已提供“单文件清单下载”的替代方案）。

- 已知限制 / 暂缓事项
  - 供应商一次任务只产出一种格式；其它格式通过“直链尝试或再生成”实现，后者需保存源图并二次提交（未启用，方案已评估）。
  - ZIP 打包为极简 store 方案，macOS 解压器对头部严格；实际生产已优先改为“文件清单下载”。若需要“一键打包”，建议接入成熟库（fflate/yazl）。
  - 历史孤儿资产（无 task_id/无文件）建议标记删除。
  - 早期贴出过密钥的会话需要旋转：Supabase SRK、R2 AK/SK、hitem3D Secret。

### 新/变更环境变量
- `RENDITIONS_INSTANT_READY_FOR_ORIGINAL`（1/0）
- `AUTO_FINALIZE_LIMIT`、`AUTO_FINALIZE_TOKEN`
- `HITEM3D_REFERER`、`HITEM3D_APPID`、`HITEM3D_UA`（供应商防盗链头）

### 主要变更文件（增量）
- 生成与 UI：
  - `components/generator/GeneratePanel.tsx`、`components/generator/GenerateForm.tsx`、`components/generator/GenerateFormMulti.tsx`
  - `app/[locale]/(default)/generate/page.tsx`
- 预览与详情页：
  - `components/assets/ViewerGLB.tsx`、`components/assets/AssetAutoPreviewGLB.tsx`
  - `app/[locale]/(default)/(console)/my-assets/[uuid]/page.tsx`
- 任务与找回：
  - `app/api/hitem3d/finalize/route.ts`、`app/api/hitem3d/finalize/batch/route.ts`、`app/api/cron/hitem3d-auto-finalize/route.ts`
  - `models/generation-task.ts`（`listSuccessTasksWithoutAsset`）、`models/asset.ts`（`updateAssetByUuid`）
- 按需格式与下载：
  - `app/api/assets/[uuid]/renditions/route.ts`、`app/api/assets/[uuid]/download/route.ts`
  - `app/api/assets/[uuid]/renditions/files/route.ts`（新）
  - `components/assets/RenditionsPanel.tsx`（OBJ 下载改新窗口清单）
- 存储：`lib/storage.ts`（`getSignedUrl` 支持 `ResponseContentDisposition`、新增 `listObjects`）
- 迁移：`data/migrations/005-create-asset-renditions.sql`
- 定时：`vercel.json`（`crons` 每 10 分钟跑一次）

### 建议的后续工作
- 方案 A（规范）：保存源图并二次提交到供应商（format=目标格式），明确计费与成功率；UI 上标明“导出将消耗积分”。
- 方案 B（当前）：直链尝试与“文件清单下载”已上线；如需“一键打包”，建议更换 ZIP 库。
- 提供管理后台“批量 finalize”按钮与状态面板，便于运维观测（当前有接口）。
- 对历史“带查询参数的对象名”进行迁移（可选），统一清理 Key 命名。

## 0. 当前目标（Step‑13）与范围
让用户完整体验“创作（预览）→ 资产（按需生成与下载）→ 广场展示 → 登录/注册”的主流程。本阶段重点完成 M0–M3 的产品化与可用性。

## 1. 已交付内容概览（按里程碑）

### M0 导航与骨架
- 顶部导航：创作（/generate）｜资产（/my-assets）｜广场（/plaza）｜登录/注册
- 页面骨架：
  - `app/[locale]/(default)/generate/page.tsx`
  - `app/[locale]/(default)/(console)/my-assets/page.tsx`
  - `app/[locale]/(default)/(console)/my-assets/[uuid]/page.tsx`
  - `app/[locale]/plaza/page.tsx`、`/plaza/[slug]/page.tsx`
- UI 测试与 E2E 导航用例已补充。

### M1 登录/注册 UI
- 自定义邮箱/密码注册与登录 UI（NextAuth CredentialsProvider）：
  - `app/[locale]/auth/register/page.tsx`
  - `app/[locale]/auth/signin/page.tsx`
  - 组件：`components/sign/register-form.tsx`、`components/sign/credentials-login-form.tsx`
- 成功注册自动登录（服务端转发 Set-Cookie）。
- UI/集成测试覆盖输入校验与 cookie 生效。

### M2 创作页（单图/多视图 + 人像）
- 组件：`components/generator/GenerateForm.tsx`
  - 默认参数：model=hitem3dv1.5、resolution=1536、request_type=1（几何）。勾选“启用纹理”→ `request_type=3`。
  - 费用提示：基于 `resolveCreditsCost`。
  - 提交：`POST /api/hitem3d/submit`，采用 1B 策略（供应商提交成功后扣费）。
  - 默认输出格式：format=1（OBJ），后台自动补齐 GLB/STL/FBX 并落库（不扣费），不影响在线预览。
  - 新增容器：`components/generator/GeneratePanel.tsx`，提供“通用/人像”切换与“单图/多视图”页签：
    - 多视图表单：`components/generator/GenerateFormMulti.tsx`，前（必选）/后/左/右四视图；仅选择前视图→走 `images`，存在任一其他视图→走 `multi_images`，顺序固定“前/后/左/右”（未选不占位）。
    - 人像模式固定纹理（`request_type=3`）、固定 `model=scene-portraitv1.5` 且仅 `resolution=1536`。
    - UI/提交均对单张图片做 20MB 限制（与供应商一致）。
- 后端改进：
  - `services/hitem3d.ts`：Token 获取主/备地址回退（任意非 2xx 即回退到 `/get-token`），错误更可读。
  - `app/api/hitem3d/submit/route.ts`：
    - 参数校验与积分不足返回；
    - `face` 映射：未传或无效时按分辨率默认值：512→500k、1024→1M、1536→2M、1536pro→2M；
    - 成功后写入 `generation_tasks`（state=created）。

### M3 我的资产（按需生成+下载+GLB 预览）
- 路由新增/改造：
  - `POST /api/assets/:uuid/renditions`：创建/返回按需导出任务（state: processing/success），幂等且不扣费。
  
## 补充更新（2025‑11‑09）

本次迭代聚焦“导航权限、极简页脚、创作页 UI 体验对齐、布局铺满一屏”。要点如下：

- 管理后台仅管理员可见（用户头像下拉）
  - 判定：`ADMIN_EMAILS` 环境变量（逗号分隔）。
  - 接口：`app/api/get-user-info/route.ts` 计算并返回 `is_admin`；类型扩展 `types/user.d.ts`。
  - 前端：`components/sign/user.tsx` 仅 `user.is_admin` 时显示“管理后台”。

- 页脚极简 + 贴底
  - 仅保留版权与法律链接（隐私政策/服务条款），固定“build with ShipAny”。
    - 代码：`components/blocks/footer/index.tsx`（大幅精简）
  - 贴底实现：
    - `app/[locale]/layout.tsx`：`body` 使用 `min-h-screen flex flex-col`；
    - `app/[locale]/(default)/layout.tsx`：`main` 改为 `flex-1`。

- 创作页（/generate）视觉与交互升级
  - 顶部 Hero 居中两行，品牌统一为“AI3DMARK”（艺术字渐变+发光，类名 `.hero-brand`，定义于 `app/globals.css`）。
  - Tabs 文案改回中文：“单图生成3D / 多视图生成3D”。
  - 模型/分辨率：从原生下拉改为“卡片选项组”（选中高亮、主色边框+阴影）。
  - 纹理开关：从复选框改为 `Switch` 滑动按钮（Radix），具备平滑动画。
  - 模型展示名称：前端仅显示版本“v1 / v1.5”（人像显示“人像 v1.5”）。
  - 上传指南：改为“悬浮或点击 → 下方浮层卡片”，不再弹窗（`components/generator/UploadGuide.tsx`）。
  - 上传交互：
    - 支持点击/拖拽替换、悬停出现替换 UI、大图一键清除；
    - 多视图右侧三卡均支持预览与替换；
    - 位置：`components/generator/GenerateForm.tsx`、`components/generator/GenerateFormMulti.tsx`。
  - 积分提示与成功引导：
    - 新增接口 `GET /api/my-credits/left`，前端展示“预计消耗 | 剩余”；
    - 提交成功后显示“前往我的资产”链接。
  - 面数 `face`：前端不再展示与传递，后端按分辨率自动映射（512→500k、1024→1M、1536/1536pro→2M）。

- 一屏铺满（Hero + 上传区域 + 页脚）
  - `app/[locale]/(default)/generate/page.tsx`：容器 `min-h-full flex flex-col`，给面板传 `fullHeight`；
  - `components/generator/GeneratePanel.tsx`：支持 `fullHeight`，面板 `h-full flex flex-col`；
  - 表单根采用 `grid-rows-[1fr_auto_auto]` 分配空间，上传卡片 `flex-1` 承担剩余高度；
  - 多视图右侧缩略图列与左大图共同自适应，避免二次滚动。

### 新/改接口与环境变量
- 新增接口：`GET /api/my-credits/left` → `{ left_credits }`。
- 环境变量：`ADMIN_EMAILS`（逗号分隔邮箱，用于前端菜单显示与服务端鉴权复用）。

### 主要改动文件（本次增量）
- 权限与用户信息：
  - `app/api/get-user-info/route.ts`、`types/user.d.ts`、`components/sign/user.tsx`
- 页脚与布局：
  - `components/blocks/footer/index.tsx`、`app/[locale]/layout.tsx`、`app/[locale]/(default)/layout.tsx`
- 创作页与上传：
  - `app/[locale]/(default)/generate/page.tsx`
  - `components/generator/GeneratePanel.tsx`
  - `components/generator/GenerateForm.tsx`、`components/generator/GenerateFormMulti.tsx`
  - `components/generator/UploadGuide.tsx`（新）
- 积分接口：`app/api/my-credits/left/route.ts`（新）

### 验收要点
- 登录管理员账号：头像下拉包含“管理后台”；非管理员不显示。
- 任意页面内容不足一屏时，页脚贴底；生成页 Hero+上传卡与页脚恰好铺满一屏，无多余空白滚动。
- 生成页：
  - Tabs 中文，品牌显示“AI3DMARK”；
  - 模型/分辨率为卡片选项，纹理为滑动开关；
  - 单图与多视图均支持预览、悬停替换、拖拽替换与清除；
  - 显示“预计消耗 | 剩余积分”；提交成功出现“前往我的资产”。

### 后续建议
- 将生成页文案与标签抽取到 i18n，便于中英切换与 A/B 测试；
- 按分辨率细化上传卡片最小高度（如 `md/lg` 断点分别设置），进一步贴合不同屏幕；
- 增加“并发上限”提示（需 `/api/generation-tasks/active-count`）；
- 视需要放开按需导出更多格式（GLB/STL/FBX）与对应下载 UI；
- 若需更具品牌识别度的“艺术字”，可引入授权的 Display 字体并本地内嵌。
  - `GET /api/assets/:uuid/renditions?format=glb&with_texture=false`：查询按需导出状态。
  - `GET /api/assets/:uuid/download`：
    - 支持 `?format=glb|obj|stl|fbx`，未就绪→409 `{ code:'WAIT_RENDITION' }`；
    - `response=json` 或历史 `format=json` 返回预签名 URL。
  - `GET /api/hitem3d/status?task_id=...`：返回 `{ state }`，并在供应商成功时附带 `{ cover_url, url }`（直链有效期约 1h）。
  - `GET /api/assets/by-task?task_id=...`：将 task 映射到 `asset_uuid`（回调/兜底入库后可用）。
  - `POST /api/hitem3d/finalize`：兜底逻辑，在回调未达时主动 query-task 并下载供应商文件落库到 R2。
- 回调处理：`app/api/hitem3d/callback/route.ts`
  - 成功：下载 `cover_url`/`url` 到 R2，创建 `assets`，在资产记录上写入 `task_id`；
  - 失败：退款一次；
  - 幂等：重复回调直接 200。
  - 下载供应商直链时默认附带 Referer/Origin（取资源 origin）、User-Agent，兼容常见 CDN 防盗链；若配置了 `HITEM3D_APPID`，会带 `Appid` 头。
- 页面与组件：
  - “我的资产”列表：`app/[locale]/(default)/(console)/my-assets/page.tsx`
    - 显示最近任务；`TaskStatus` 轮询状态、解析 `asset_uuid`。
    - 任务成功但本地未落库时（供应商直链可用）：
      - 若为 GLB：嵌入 `<model-viewer>` 在线预览（组件 `components/assets/ViewerGLB.tsx`）。
      - 否则提示“不可在线预览（例如 OBJ 缺少 .MTL/贴图）”，提供“临时下载”。
    - 也可手动“刷新状态”（会触发 `finalize` 兜底下载）。
  - 资产详情页：`app/[locale]/(default)/(console)/my-assets/[uuid]/page.tsx`
    - 包含 `RenditionsPanel`：四种格式按需生成/轮询/下载（就绪后启用下载）。

## 2. i18n 与导航
- 暂仅中文：`i18n/locale.ts` → `locales=['zh']`，`defaultLocale='zh'`；中间件 matcher 限定 zh 系列。
- 隐藏语言切换：`i18n/pages/landing/zh.json` → `header.show_locale=false`。

---

## 本次对话增量（2025‑11‑06）

- OBJ 下载与调试改进（files 清单接口）
  - 兼容路径与鉴权：统一将反斜杠改为正斜杠，继承供应商直链的鉴权 query（如 auth_key）。
  - MTL 兜底：除解析 `mtllib` 外，额外尝试 `<objBase>.mtl`、`0.mtl`、`materials.mtl`，并增加目录变体（去掉 `/model/` 段）。
  - ZIP 直通：优先探测供应商 `base.obj.zip/base.zip`，命中则直接保存为 `file.obj.zip` 并返回。
  - 重试触发：当目录中“只有 .obj”时会自动再次尝试补齐 `.mtl/贴图` 或 ZIP。
  - 调试输出：`GET /api/assets/:uuid/renditions/files?format=obj&debug=1` 返回 `debug.steps/uploads`（已脱敏），包含 `zip_candidates`/`fetch_zip_head|get`、`parse_mtllib`、`mtl_candidates`、`mtl_candidate_urls`、`fetch_mtl`、`parse_textures`、`fetch_texture`。
  - 主要文件：`app/api/assets/[uuid]/renditions/files/route.ts`、`app/api/assets/[uuid]/renditions/route.ts`。

- 自动补齐四种格式（不扣费，不影响预览）
  - 回调与 Cron 成功后，后台自动尝试补齐 GLB/STL/FBX（以及 OBJ 的 ZIP 变体）并落库到 R2，记录到 `asset_renditions`。
  - 候选规则：`base.<fmt>.zip`、`base.zip`、`base.<fmt>`（先 HEAD 后 GET）。
  - 主要文件：`app/api/hitem3d/callback/route.ts`、`app/api/cron/hitem3d-auto-finalize/route.ts`、`models/asset-rendition.ts`。

- 生成页（模型/分辨率全面覆盖 + 人像约束）
  - 通用模式：仅显示 `hitem3dv1 / hitem3dv1.5`；分辨率按模型可选（v1: 512/1024/1536；v1.5: 512/1024/1536/1536pro）；纹理可勾选。
  - 人像模式：强制 `scene-portraitv1.5` 且分辨率固定 `1536`，纹理强制开启；UI 隐藏下拉，仅展示只读徽标。
  - 成本提示随“模型/分辨率/纹理”动态更新。
  - 默认提交 OBJ（`format=1`），后台自动补齐 GLB 供在线预览。
  - 主要文件：`components/generator/GeneratePanel.tsx`、`components/generator/GenerateForm.tsx`、`components/generator/GenerateFormMulti.tsx`。

- 管理员免扣积分（便于功能测试）
  - 管理员判定：`ADMIN_EMAILS` 环境变量中的邮箱（逗号分隔）。
  - 行为：管理员提交时不做余额校验、不扣减积分，`generation_tasks.credits_charged=0`。
  - 主要文件：`app/api/hitem3d/submit/route.ts`。

- 其他
  - 修复 Next Route GET 返回类型（始终返回 `Response`）；ZIP 探测移入内部物化函数。
  - 文档更新：默认格式改为 OBJ，接口说明已调整；保留“按需格式”与调试端点说明。

### 快速验证
- 生成：在通用/人像模式分别选择模型与分辨率提交，观察 `my-assets` 列表出现任务并进入 success。
- 补齐：详情页等待后台自动补齐 GLB/STL/FBX；或通过 Cron 路由触发（需 `AUTO_FINALIZE_TOKEN`）。
- OBJ 清单：`GET /api/assets/:uuid/renditions/files?format=obj&debug=1` 检查 `files` 与 `debug.steps`；若仅有 .obj，将自动再次触发补齐尝试。

### 相关改动清单（节选）
- `app/api/assets/[uuid]/renditions/files/route.ts`（调试/ZIP/兜底/重试）
- `app/api/assets/[uuid]/renditions/route.ts`（ZIP/直链候选、OBJ 打包改进）
- `app/api/hitem3d/callback/route.ts`（回调成功后自动补齐多格式）
- `app/api/cron/hitem3d-auto-finalize/route.ts`（定时补齐）
- `app/api/hitem3d/submit/route.ts`（管理员免扣积分、默认 OBJ 回退）
- `components/generator/*`（模型/分辨率选择与人像约束）

## 3. 关键接口约定（新增/改造）
- `POST /api/hitem3d/submit`
  - FormData：`images/multi_images`（任一必填）`request_type`（1/3）、`model`（hitem3dv1.5 默认）、`resolution`（1536 默认）、`format=1`（OBJ，后台自动补齐 GLB/STL/FBX）、`mesh_url?`（2 时必填）。
  - 错误映射：当计费规则非法（如人像+非1536）时，返回 400 + 可读提示。
  - 1B 扣费策略：供应商提交成功后扣费；失败回调自动退款；幂等由 `generation_tasks` 保障。
- `POST /api/hitem3d/callback`：见上（回调落库）。
- `GET /api/hitem3d/status?task_id=...`：返回 `{ state, cover_url?, url? }`。
- `POST /api/hitem3d/finalize { task_id }`：状态成功但未落库时触发兜底下载与落库。
- `POST /api/assets/:uuid/renditions { format, with_texture? }`：创建/返回按需导出任务（不扣费）。
- `GET /api/assets/:uuid/renditions?format=...&with_texture=...`：查询 state。
- `GET /api/assets/:uuid/download?format=...`：按需导出就绪则下载；未就绪 409 `{ code:'WAIT_RENDITION' }`；`response=json` 返回预签名 URL。
- `GET /api/assets/by-task?task_id=...`：返回 `{ asset_uuid }`。

## 4. 环境变量（预发务必配置）
- hitem3D：
  - `HITEM3D_API_BASE`（默认 `https://api.hitem3d.ai`）
  - `HITEM3D_CLIENT_ID`、`HITEM3D_CLIENT_SECRET`
  - `HITEM3D_CALLBACK_URL`（例：`https://<域名>/api/hitem3d/callback`）
  - `HITEM3D_TOKEN_TTL_SECONDS`（可选）
  - 可选：`HITEM3D_APPID`、`HITEM3D_REFERER`、`HITEM3D_UA`
- 存储（R2/S3 兼容）：
  - `STORAGE_ENDPOINT`、`STORAGE_REGION`（R2 一般 `auto`）
  - `STORAGE_ACCESS_KEY`、`STORAGE_SECRET_KEY`
  - `STORAGE_BUCKET`（必填）
  - 可选：`STORAGE_DOMAIN`、`STORAGE_DOWNLOAD_MODE`（`presigned` 或 `proxy`）
- Auth/Next：`AUTH_SECRET` 等。

## 5. 业务决策与默认策略
- 预览优先：创作页只产出“可预览基础模型”。
- 默认输出 GLB：提交时 `format=2`，便于内嵌 `<model-viewer>` 在线预览。
- 面数默认映射（未传/无效）：512→500k、1024→1M、1536→2M、1536pro→2M。
- 按需导出/下载：详情页点击格式按钮时触发（不额外扣费，幂等不重复创建）。
- 临时预览兜底（方案 A）：任务 success 且本地未落库时，若供应商直链为 `.glb`，页面内直接预览；非 `.glb` 则提示“不可在线预览”并提供临时下载。
- 供应商直链下载兼容（方案 B）：回调/兜底下载时默认附带 Referer/Origin（取资源 origin）与 UA，必要时可加 `Appid`。

## 6. 常见问题与排查
- 提交 500：多数为缺少 `HITEM3D_CLIENT_ID/SECRET` 或 token 接口镜像问题。现已支持主/备回退；错误信息会直出（例如“分辨率/面数不合法”）。
- 面数错误：供应商提示“面数设置不合理（100000～2000000）”。服务端现已按分辨率默认面数自动填充。
- 回调未达：
  - 检查 `HITEM3D_CALLBACK_URL` 是否在供应商侧生效（是否需要白名单/签名）。
  - Vercel 日志搜 `/api/hitem3d/callback`；若没有，可以用 `POST /api/hitem3d/finalize` 兜底。
- 403 下载直链：
  - 多为 CDN 防盗链/过期。我们默认附带 Referer/Origin（资源 origin）与 UA；
  - 若仍 403：与供应商确认是否需额外头（如 Appid/Cookie/签名）与直链有效期策略；临时使用“在线预览（GLB）/临时下载”。

## 7. 测试（Vitest/Playwright）
- 运行：
  - `cd shipany-template && pnpm test`（Vitest，全量）
  - E2E（需 baseURL）：`PLAYWRIGHT_BASE_URL=<预发域> pnpm e2e`
 - 主要新增测试：
  - UI：导航渲染、登录/注册表单校验、生成表单（默认 `format=2`）、任务面板等。
  - 集成：hitem3d submit/callback/status/finalize，renditions 路由、assets 下载 409/302/JSON。

## 8. 主要文件清单（新增/改动）
- 前端页面/组件：
  - 生成页：`app/[locale]/(default)/generate/page.tsx`、`components/generator/GenerateForm.tsx`
  - 我的资产列表：`app/[locale]/(default)/(console)/my-assets/page.tsx`、`components/assets/TaskStatus.tsx`、`components/assets/ViewerGLB.tsx`
  - 资产详情：`app/[locale]/(default)/(console)/my-assets/[uuid]/page.tsx`、`components/assets/RenditionsPanel.tsx`
- 路由：
  - hitem3d：`/api/hitem3d/submit`、`/status`、`/callback`、`/finalize`
  - assets：`/api/assets/[uuid]/download`、`/api/assets/[uuid]/renditions`、`/api/assets/by-task`
- i18n：`i18n/locale.ts`（仅 zh）、`i18n/pages/landing/zh.json`（导航与隐藏语言切换）

## 9. 下一步建议（未完项）
- 资产详情页：在本地文件就绪时内置 `<model-viewer>` 预览（当前仅任务卡片层面做临时预览）。
- renditions：补全资产侧落库与格式导出持久化（目前通过模型/路由模拟状态；如需 DB 迁移 `asset_renditions` 表，请补迁移）。
- Plaza（M4）：发布/下线/举报流程与 UI。
- 价格页降级逻辑（Stripe 未接入时的按钮状态）。
- 进一步的回调监控/告警：便于尽早发现回调未达。

## 10. 预发验证清单
1) 登录/注册：邮箱+密码，注册成功自动登录。
2) 生成：/zh/generate 上传小图，提交成功返回 `task_id` 并提示“预览生成中”。
3) 我的资产：/zh/my-assets 出现任务卡片，状态由 processing→success；
   - 若已落库：出现“查看详情”；
   - 若未落库且供应商直链为 GLB：页面内在线预览可用；非 GLB 显示“临时下载”。
4) 详情页按需格式：点击 GLB/OBJ/STL/FBX 触发 `POST /renditions` → 轮询 `GET /renditions`，就绪后下载 200；未就绪 409。

---

如需支持邮件沟通供应商的说明模板（回调未达与直链 403），可参考：
- 回调 URL：`https://<域名>/api/hitem3d/callback`，请求对方确认是否需要白名单/签名；
- 403 下载：我们已附带 Referer/Origin（资源 origin）与 UA，仍遇到 403，请告知是否需要额外头（Appid/Cookie/签名）与直链有效期策略。

> 注：本交接涵盖代码与配置的“现状”与“已知限制”。下一步可按“下一步建议”逐项推进，以打通端到端体验与可观测性。

---

## 补充更新（2025‑11‑09）供应商 ZIP 落库与 OBJ 预览修复（本次对话）

背景：实测“人像任务”常返回带鉴权参数的 ZIP 直链（如 `0.zip?auth_key=...&t=...`）。浏览器点击可直接下载，但服务端落库偶发 `403`，导致资产未入库、详情页 OBJ 预览不可用。

根因与思路：
- 并非“人像 vs 非人像”的业务差异，而是不同产物分发域名/策略差异。此前我们默认发送 `Referer/Origin` 可能触发部分 CDN 的防盗链；而浏览器直链下载通常不带固定 Referer，反而能通过。
- 直链可能回 `*.zip` 或 `*.obj.zip`。原实现仅识别 `file.obj.zip`，未覆盖 `file.zip` 的解包路径。

修复要点：
- 放宽供应商下载请求头（避免无谓的 403）：
  - 不再强制发送 `Referer/Origin`（除非显式配置 `HITEM3D_REFERER`）。
  - 统一添加浏览器常见请求头：`User-Agent=Mozilla/5.0`、`Accept=*/*`、`Accept-Language=zh-CN,zh;q=0.9,en;q=0.8`。
- finalize/回调/兜底导出全链路增强：
  - 忽略“封面下载失败”，不再中断“主文件入库”。
  - 当 queryTask 返回的 `url` 不可访问时，自动回退尝试同目录 `*.obj.zip` 与 `*.zip`（命中则保存为 `file.zip`）。
- OBJ 文件清单端点增强：
  - 除了供应商 ZIP 直通外，可从 R2 中已存在的 `file.zip` 或 `file.obj.zip` 自动解包到 `assets/<user>/<asset>/obj/`，并对 `.obj/.mtl/贴图` 统一 `inline` 签名，确保子资源可被 Three.js 直接加载。
- UI 提示修正：
  - 列表页仅对 GLB 提供临时直链预览；非 GLB 场景提示引导“去详情页做 OBJ 在线预览”；并修复“带 query 的直链扩展名识别”。
- 诊断工具新增：
  - `GET /api/debug/vendor-fetch?url=...`：服务器直连供应商 URL 的探测（返回 status/ok/headers/size），便于快速定位 `403/网络差异`。
  - `GET /api/debug/hitem3d/finalize?task_id=...`：一键触发 finalize 兜底（浏览器即可操作）。

影响文件：
- 头部策略与容错：
  - `app/api/hitem3d/callback/route.ts`
  - `app/api/hitem3d/finalize/route.ts`
  - `app/api/assets/[uuid]/renditions/route.ts`
  - `app/api/cron/hitem3d-auto-finalize/route.ts`
- OBJ 清单/解包：
  - `app/api/assets/[uuid]/renditions/files/route.ts`
- 调试端点：
  - `app/api/debug/vendor-fetch/route.ts`
  - `app/api/debug/hitem3d/finalize/route.ts`
- UI：
  - `components/assets/TaskStatus.tsx`

快速验证：
1) 服务器是否能拉到供应商 ZIP：
   - 浏览器登录后访问 `GET /api/debug/vendor-fetch?url=<encodeURIComponent(供应商直链)>`，期望 `status=200`。
2) 一键 finalize（入库）：
   - `GET /api/debug/hitem3d/finalize?task_id=...` 返回 `{ code:0, data:{ asset_uuid } }`。
3) 详情页 OBJ 预览：
   - `/my-assets/<asset_uuid>?objdebug=1` 看到加载进度→渲染模型。
4) 若仍未就绪：
   - `GET /api/assets/<asset_uuid>/renditions/files?format=obj&debug=1` 查看物化/解包步骤与签名文件清单。

可选配置：
- 本次修复不依赖 `HITEM3D_APPID/HITEM3D_REFERER`；如供应商提供固定 Referer 要求，可补上 `HITEM3D_REFERER` 以提升一致性。

已知风险与边界：
- 供应商直链有效期有限（带鉴权参数），应尽快 finalize 入库。
- 个别地域/网络差异仍可能造成服务端偶发失败；此时可借助“调试端点 + 再次尝试”，或后续引入“浏览器辅助入库（前端直传 R2）”。

备注：本次修复已在预发域验证“人像 ZIP 直链 → 入库 → OBJ 预览”闭环可用。

---

## 补充更新（2025‑11‑09）登录交互统一与鉴权调试

本次补充聚焦“统一登录入口与样式（以模板为准）”以及“邮箱帐密登录误判失败”的定位与修复，并新增了鉴权调试页。

### 1) 统一登录交互（以模板弹窗为准）
- 移除顶部导航中的“登录/注册”重复入口，仅保留右侧按钮触发的弹窗登录（SignModal）。
  - 变更：`i18n/pages/landing/zh.json`（删除 `header.nav.items` 中 `"登录/注册"`）；
  - 文案：`i18n/messages/zh.json` 将 `user.sign_in` 调整为“登录/注册”。
- 弹窗内集成邮箱密码登录 + 注册：
  - `components/sign/modal.tsx`：新增 `mode: 'login'|'register'` 切换；上方展示 OAuth（Google/GitHub）按钮，下方卡片在“邮箱登录/注册”之间切换；注册成功后关闭弹窗并刷新。
  - `components/sign/credentials-login-form.tsx`：支持 `hideRegisterLink`、`onSwitchToRegister`，成功后刷新当前页（而非强制跳首页）。
  - `components/sign/register-form.tsx`：支持 `hideSigninLink`、`onSwitchToLogin`、`onSuccess` 回调，便于嵌入弹窗。

环境变量（与模板一致）：
- `AUTH_SECRET`（openssl rand -base64 32 生成）
- Google：`AUTH_GOOGLE_ID`、`AUTH_GOOGLE_SECRET`、`NEXT_PUBLIC_AUTH_GOOGLE_ID`、`NEXT_PUBLIC_AUTH_GOOGLE_ENABLED="true"`
- GitHub（可选）：`AUTH_GITHUB_ID`、`AUTH_GITHUB_SECRET`、`NEXT_PUBLIC_AUTH_GITHUB_ENABLED="true"`
- One Tap（可选）：`NEXT_PUBLIC_AUTH_GOOGLE_ONE_TAP_ENABLED="true"`（需同时配置 `NEXT_PUBLIC_AUTH_GOOGLE_ID`）

### 2) 帐密登录误判失败（但实际已登录）的修复
现象：邮箱登录接口返回 401（前端弹窗提示“帐密错误”），但随后访问“资产/创作”等页面显示为已登录。

原因：在部分环境下，Auth.js/NextAuth 会在 Route Handler 内部通过 `next/headers` 的 `cookies()` 直接写入会话 Cookie；此时 `signIn()` 不一定返回 `Response` 或 `ok=true`，导致我们只看返回值会误判失败。

修复（/api/auth/login 与 /api/auth/register）：
- 视以下任一条件为成功：
  - `signIn()` 返回 `Response` 且 `ok` 或 3xx；
  - `Response` 返回头中包含 `Set-Cookie`，并转发给客户端；
  - “已处于登录态”（登录前检查 `auth()`）；
  - 登录前后对比 `cookies()` 快照，若发现会话 Cookie 名称变更/新增（`authjs.session-token`、`__Secure-authjs.session-token`、`next-auth.session-token`、`__Secure-next-auth.session-token`），则判定为成功。
- 兼容 Next 15：`cookies()` 可能为 Promise，增加 `getCookieMap()` 辅助函数进行异步快照。

主要改动文件：
- `app/api/auth/login/route.ts`：成功判定标准统一；新增“登录前后 Cookie 快照对比”；已登录兜底为成功；登录后再次兜底检查 `auth()`。
- `app/api/auth/register/route.ts`：注册后的自动登录同样透传 `Set-Cookie`，并加入 Cookie 变更检测。

### 3) 鉴权 Debug 工具（便于线上复现与定位）
- 开关：`DEBUG_AUTH=true`（已加入 `.env.development.example`）。
- 调试接口：
  - `POST /api/debug/auth/login`：与正式登录同路由逻辑，返回调试信息（`isResponse/status/ok/Set-Cookie`、`cookie.before/after/changed`、`treatedSuccess`）。
  - `GET /api/debug/auth/session`：返回 `session` 与 `sessionExists`。
- 调试页面：`/[locale]/debug/auth`（如 `/zh/debug/auth`），可输入邮箱/密码，查看“登录结果”和“会话结果”的原始 JSON。

### 4) 构建兼容性
- 修复 Next 15 类型变更导致的构建报错：`cookies()` 适配为异步读取（`getCookieMap()`）。

### 5) 提交记录（部分）
- 统一登录入口与文案：`4b5b3f8`、`b8ab7a7`、`333f84b`
- 登录判定与 UX：`5e6a34c`、`c2ac41e`、`d5bb425`、`be4cbed`、`81921be`
- 调试工具：`3fa6f61`

### 6) 验收建议
- 开启 Google（或 GitHub）后，弹窗应显示相应 OAuth 按钮；未配置时仅显示邮箱登录/注册卡片。
- 邮箱“登录/注册”均应直接成功并刷新当前页，不再出现“提示失败但已登录”的误判。
- 调试页 `/zh/debug/auth`：
  - Test Login 返回 200；`debug.cookie.changed=true` 或 `treatedSuccess=true`；
  - Check Session 返回 `sessionExists=true`。

### 7) 已知事项与后续
- 若需要彻底移除 `/auth/register` 页面入口（仅保留弹窗注册），可以继续清理其它页面中的相关链接。
- 如遇到自定义代理/CDN 导致 `Set-Cookie` 被剥离，可使用“Cookie 快照对比 + 兜底 session 检查”策略继续规避，或在边缘层放行该路径的响应头。
