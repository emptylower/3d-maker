# 产品需求文档（PRD）— Hitem3D 建模广场 MVP

## 背景与目标
- 目标：提供基于 Hitem3D API 的在线 3D 建模服务与作品广场。仅在“创建建模任务”时要求登录与扣积分，其余浏览/投稿尽量开放。
- 部署：Vercel（Next.js 全栈），数据：Supabase Postgres + Storage，支付：Stripe。

## 角色与权限
- 访客：浏览广场与作品详情、3D 预览。
- 注册用户：邮箱注册/登录；创建建模任务（扣积分）、发布到广场、查看钱包余额/流水。
- 管理员：唯一邮箱指定；可下架广场作品，查看任务日志与积分流水。

## 用户故事与验收标准（GWT）
1) 注册与登录
- Given 用户使用邮箱注册，When 完成邮件验证/登录，Then 系统创建钱包并发放“注册奖励积分”。
- Given 用户重复登录，When 登录成功，Then 不重复发放奖励且钱包余额准确。

2) 购买积分（Stripe）
- Given 用户在积分中心选择套餐，When 创建 Checkout 并支付成功，Then Webhook 入账到钱包并记流水；重复推送仅一次入账。
- Given 支付失败/取消，When 返回站点，Then 不发生入账。

3) 提交建模任务
- Given 用户已登录且余额充足，When 上传图片并点击创建任务，Then 原子扣减积分→获取 token→提交 Hitem3D 任务→记录任务 id。
- Given 余额不足，When 提交任务，Then 提示“积分不足”并拒绝。
- Given Hitem3D 返回失败，When 任务失败，Then 自动回滚积分并记录失败原因。

4) 任务结果与展示
- Given 任务成功，When 回调/轮询得到 glb/obj 链接，Then 保存到数据库，用户可进入详情页用 Three.js 预览。
- Given 链接失效，When 前端加载失败，Then 展示友好错误并建议重新生成/联系支持。

5) 广场投稿与浏览
- Given 用户已生成成功任务，When 选择任务创建广场帖子，Then 公开展示（默认未审核，管理员可下架）。
- Given 访客打开广场，When 浏览列表/详情，Then 可以 3D 预览与查看描述信息（不展示源文件下载）。

6) 管理员下架
- Given 管理员登录，When 在后台点击下架，Then 帖子状态变为 removed 且从公开列表隐藏，记录操作人与原因。

## 关键业务规则
- 上传图片限制：格式 png/jpeg/jpg/webp；最大 20MB；单图或多视图（最多 4 张）— 与 Hitem3D 接口一致。
- 任务类型：一次性生成（几何+纹理）或分阶段（先几何后纹理）；模型版本/分辨率按文档提供枚举。
- 计费/积分：创建建模任务前扣积分；失败自动退款；退款写负向流水。
- 展示：仅在线 3D 预览，不提供模型源文件下载；可选生成封面图用于列表卡片（后续优化）。

## 非功能性需求
- 可用性：核心流程（登录、提交任务、回调入账）SLO 99.9%。
- 性能：广场列表 TTFB < 500ms（缓存/静态），模型详情首次加载 3D 资源依赖网络；后端 API P95 < 300ms（不含外部 API）。
- 安全：RLS 限制用户仅能操作本人数据；Webhook 验签；限流与防刷；敏感日志脱敏。

## 参数确认（已确定）
- 注册奖励积分：80
- 每次建模任务所需积分（按模型版本）：
  - 通用模型 v1.0：40/次（所有分辨率）
  - 通用模型 v1.5：80/次（所有分辨率）
  - 人像模型：60/次（所有分辨率）
- Stripe 套餐与积分映射：
  - plus：$10 → 200 积分
  - pro：$20 → 800 积分
  - pro Max：$100 → 4500 积分
- 管理员邮箱（env）：lijianjie@koi.codes（唯一管理员）
- 任务失败策略：自动全额退还已扣积分
- 兜底轮询：启用 Supabase Scheduler 定时 query-task

> 提示：Hitem3D API 的 Client ID/Secret 作为环境变量配置，不写入仓库。
